Cost Saver
==============================================================================


Overview
------------------------------------------------------------------------------
为了节约开销, 我希望当服务器长时间没有玩家在线时, 或是因为任何原因导致服务器处于不可用的状态 (例如 EC2 或者 RDS 挂掉了, 不手动重启是无法恢复的), 我们就希望关闭 (不是删除) EC2 和 RDS 以节约开销.

本文将详细拆解这个需求并给出解决方案, 请按照章节顺序阅读, 以对为什么最终的解决方案是这样设计有一个清晰的认识.


Server Status Measurement
------------------------------------------------------------------------------
为了做到节约开销, 对服务器的状态进行测量是必不可少的. 我们需要测量的数据包括:

- EC2 是否在线 (running): 用 AWS API 既可.
- RDS 是否在线 (available): 用 AWS API 既可.
- 游戏服务器是否在线 (wow_status): 用 `acore_soap_app 中的 is_server_oneline <https://acore-soap-app.readthedocs.io/en/latest/acore_soap_app/sdk/canned/impl.html#acore_soap_app.sdk.canned.impl.is_server_online>`_ 方法既可.
- 在线玩家数量 (online_players), 只有在服务器在线的时候才会有这个数据: 用 `acore_soap_app 中的 get_online_players <https://acore-soap-app.readthedocs.io/en/latest/acore_soap_app/sdk/canned/impl.html#acore_soap_app.sdk.canned.impl.get_online_players>`_ 方法既可.

有了这些数据, 我们就可以轻易的对服务器的状态进行分析判断, 从而决定是否关闭服务器. 并且这些数据还可以用来做其他的分析, 例如服务器的在线人数分析, CPU利用率, 内存利用率监控等.


How to Measure
------------------------------------------------------------------------------
我们需要写一个定时脚本来测量服务器的状态.

- 对于 EC2 和 RDS 的在线状态, 这个脚本可以运行在任何地方, 可以是 EC2 服务器上 (这个脚本占用的系统资源可以忽略不计), 也可以是 Lambda Function 中. 我建议用 Lambda Function 来测量 EC2 和 RDS 的状态, 因为 EC2 本身如果挂了, 那么 EC2 上的测量脚本也就挂了.
- 对于游戏服务器的状态, 由于要跟 EC2 上的 SOAP server 通信, 如果你用 Lambda Function + SSM Run Command 异步调用 SOAP API 测量的话会有 3 - 5 秒的延迟, 也就是说 Lambda 要在那里 Wait 个 3-5 秒, 这个开销对于 Lambda 来说是很不划算的. 所以我建议直接在 EC2 运行测量游戏服务器状态的脚本. 如果某个时间段数据库中没有数据, 我们就将其视为服务器挂了既可.

根据以上的讨论, 我们会发现如果将不同类型的测量数据分别用 EC2 和 Lambda 测量, 这样能节约 Lambda 的开销, 但是由于一次对数据库的写入变成了两次写入. 我们下面来计算一下这两种方案的开销.


Cost Estimation
------------------------------------------------------------------------------
下面的计算是基于只有一台服务器的假设. 计算出来的结果可以作为基准, 最终有几台服务器就乘以几既可.

计算过程请参考这个 `Google Sheet <https://docs.google.com/spreadsheets/d/1jjL8wNdTNKjIKPjkJKKQkJ_CuixjWJcJckxzqxGFX1k/edit?gid=529878799#gid=529878799>`_, 这里我们直接放结论:

按照每 5 分钟测量一次服务器状态, 每 15 分钟运行一次 Cost Saver Lambda Function 测算, 方案 1 是用 Lambda 来测量所有的数据, 方案 2 是用 EC2 测量游戏服务器相关的指标以及 Lambda 测量其他指标.

- 方案 1 是每台服务器 $0.19 / 月.
- 方案 2 是每台服务器 $0.08 / 月.


When to Stop EC2 and RDS
------------------------------------------------------------------------------
数据预处理:

- 我们每 15 分钟运行一次 Cost Saver Lambda Function. 它会从 DynamoDB 中读取最近 3 个小时的数据. 例如我现在是下午 5:12PM, 那么我们会减去 5 分钟然后按照 5 分钟向下取整, 也就是 Query 5:05PM (5:07PM 向下取整) 到 2:05 PM 中间的所有数据.
- 由于测量的时间不可能是整点, 所以我们需要对数据进行采样处理. 采样规则是这样的. 例如我们要确定 3:20PM 时刻的服务器状态, 我们就会检查 3:20-3:25PM 之间是否是否有测量数据, 如果有就拿来用. 如果没有则检查 3:20-3:30PM 之间是否有测量数据, 如果有就拿来用. 如果还没有就将该时刻的数据视为缺失.

现在我们有一个过去 3 小时, 每 5 分钟测量一次的数据了, 我们需要对这些数据进行分析, 以决定是否关闭 EC2 和 RDS.

1. 如果连续 2 小时游戏服务器的在线人数数据都是缺失的, 那么我们就认为服务器挂了, 需要关闭 EC2 和 RDS (如果已经关闭了则忽略).
2. 如果连续 2 小时游戏服务器的在线人数都有值, 且是 0 人, 那么我们就认为服务器长时间没有玩家在线, 需要关闭 EC2 和 RDS.
3. 如果连续 2 小时游戏服务器的在线人数都有值, 且有至少一个值大于 0 人, 那么就什么都不做.
4. 如果 2 小时期间有部分数据是缺失的, 只要有一个时间点在线人数有值, 不管是 0 还是多少, 都是视为服务器还在频繁启动, 关闭的调试状态, 那就什么都不做.
